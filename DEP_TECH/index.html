<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Carte des Risques Technologiques</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-text: #2c3e50;
            --secondary-text: #7f8c8d;
            --bg-color: #f0f2f5;
            --col-nucleaire: #E6C229; 
            --col-indus: #7E7973;     
            --col-seveso: #6B8E23;    
        }

        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; display: flex; height: 100vh; overflow: hidden; background: var(--bg-color); color: #333; }
        * { box-sizing: border-box; }

        #layout-container { display: flex; width: 100%; height: 100%; }

        .sidebar {
            width: 380px; 
            background: white; 
            z-index: 1000; 
            box-shadow: 4px 0 20px rgba(0,0,0,0.08);
            display: flex; 
            flex-direction: column; 
            padding: 30px; 
            overflow-y: auto;
            flex-shrink: 0; 
        }

        .sidebar-header { margin-bottom: 30px; }
        .sidebar-title {
            font-family: 'Montserrat', sans-serif; font-size: 1.6rem; font-weight: 700; color: var(--primary-text);
            margin: 0 0 10px 0; letter-spacing: -0.5px; line-height: 1.2;
        }
        .sidebar-subtitle { font-size: 0.95rem; color: var(--secondary-text); line-height: 1.5; }

        .risk-selector { display: flex; flex-direction: column; gap: 12px; }
        
        .risk-item {
            display: flex; align-items: center; padding: 12px 15px; border-radius: 12px;
            background: #f8f9fa; border: 2px solid transparent; cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .risk-item:hover { background: #eef2f5; transform: translateX(5px); }
        .risk-item.active { background: white; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }

        .risk-item[data-risk="nucleaire"].active { border-color: var(--col-nucleaire); }
        .risk-item[data-risk="industriel"].active { border-color: var(--col-indus); }
        .risk-item[data-risk="seveso"].active { border-color: var(--col-seveso); }

        .risk-icon { 
            width: 36px; height: 36px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            margin-right: 15px; font-size: 1.1rem; color: white; flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .risk-name { font-weight: 600; color: var(--primary-text); font-size: 0.95rem; }

        .risk-item[data-risk="nucleaire"] .risk-icon { background: var(--col-nucleaire); }
        .risk-item[data-risk="industriel"] .risk-icon { background: var(--col-indus); }
        .risk-item[data-risk="seveso"] .risk-icon { background: var(--col-seveso); }

        .legend-container { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; }
        .legend-title { font-size: 0.8rem; text-transform: uppercase; color: #aaa; font-weight: 700; margin-bottom: 15px; letter-spacing: 1px; }
        .legend-row { display: flex; align-items: center; margin-bottom: 12px; color: #555; font-size: 0.9rem; }
        .legend-circle { border-radius: 50%; display: inline-block; margin-right: 12px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }

        .details-wrapper { margin-top: auto; padding-top: 20px; }
        .details-toggle {
            padding: 12px; text-align: center; color: var(--secondary-text); 
            cursor: pointer; font-size: 0.9rem; font-weight: 500;
            border-radius: 8px; background: #f9f9f9;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.2s;
        }
        .details-toggle:hover { background: #e0e0e0; color: var(--primary-text); }
        
        .details-panel {
            display: none; 
            background: #fff; padding: 15px; border-radius: 8px; 
            font-size: 0.85rem; color: #666; margin-top: 10px; line-height: 1.6;
            border: 1px solid #eee;
        }

        #map { flex: 1; height: 100%; z-index: 1; background: #e5e9ec; }

        .leaflet-popup-content-wrapper { border-radius: 12px !important; box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important; padding: 0 !important; overflow: hidden; }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        .leaflet-container a.leaflet-popup-close-button { color: white !important; top: 10px; right: 10px; font-size: 18px; }

        .custom-popup-header { background: #333; color: white; padding: 15px; font-family: 'Montserrat'; font-size: 1rem; font-weight: 700; }
        .custom-popup-body { padding: 15px; background: white; }
        .popup-stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; color: #555; }
        .popup-stat-val { font-weight: 700; color: #222; }
    </style>
</head>
<body>

    <div id="layout-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Risques Tech.</div>
                <div class="sidebar-subtitle">Visualisez l'intensité des aléas technologiques par département.</div>
            </div>

            <div class="risk-selector">
                <div class="risk-item active" onclick="changeRisk('nucleaire')" data-risk="nucleaire">
                    <div class="risk-icon"><i class="fa-solid fa-radiation"></i></div>
                    <div class="risk-name">Nucléaire</div>
                </div>
                <div class="risk-item" onclick="changeRisk('industriel')" data-risk="industriel">
                    <div class="risk-icon"><i class="fa-solid fa-industry"></i></div>
                    <div class="risk-name">Industriel</div>
                </div>
                <div class="risk-item" onclick="changeRisk('seveso')" data-risk="seveso">
                    <div class="risk-icon"><i class="fa-solid fa-flask"></i></div>
                    <div class="risk-name">Seveso</div>
                </div>
            </div>

            <div class="legend-container" id="legend-content"></div>

            <div class="details-wrapper">
                <div class="details-toggle" onclick="toggleDetails()">
                    <span><i class="fa-solid fa-circle-info"></i> Comprendre les données</span>
                    <i class="fa-solid fa-chevron-down" id="chevron-icon"></i>
                </div>
                <div class="details-panel" id="details-text">
                    </div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="CENTROIDE.json"></script> 

    <script>
        const CONFIG = {
            'nucleaire': { 
                label: 'Nucléaire', color: '#E6C229', field: 'Nucléaire', max: 100,
                unit: 'Communes',
                description: 'le nombre de communes situées à proximité d\'une installation nucléaire.'
            },
            'industriel': { 
                label: 'Industriel', color: '#7E7973', field: 'Risque_ind', max: 300,
                unit: 'Communes',
                description: 'le nombre de communes concernées par un Plan de Prévention des Risques Technologiques (PPRT).'
            },
            'seveso': { 
                label: 'Seveso', color: '#6B8E23', field: 'Seveso 202', max: 80,
                unit: 'Sites Seveso',
                description: 'le nombre d\'établissements classés Seveso (seuils haut et bas) répertoriés.'
            }
        };

        let map;
        let currentGeoJsonLayer = null;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([46.6, 2.5], 6);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(map);
            L.control.zoom({ position: 'topright' }).addTo(map);
            loadRiskLayer('nucleaire');
        }

        function changeRisk(riskKey) {
            document.querySelectorAll('.risk-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.risk-item[data-risk="${riskKey}"]`).classList.add('active');
            loadRiskLayer(riskKey);
        }

        function loadRiskLayer(key) {
            if (currentGeoJsonLayer) map.removeLayer(currentGeoJsonLayer);
            const conf = CONFIG[key];

            // Mise à jour de l'accordéon "Détails"
            document.getElementById('details-text').innerHTML = `
                <p><strong>Source :</strong> Observatoire des Territoires (2025)</p>
                <p>Les cercles indiquent ${conf.description}</p>
                <p>La taille est proportionnelle au nombre de ${conf.unit.toLowerCase()} par département.</p>
            `;

            currentGeoJsonLayer = L.geoJSON(centroide, {
                filter: (f) => (f.properties[conf.field] || 0) > 0,
                pointToLayer: function(feature, latlng) {
                    const val = feature.properties[conf.field] || 0;
                    const radius = calculateRadius(val, conf.max);
                    return L.circleMarker(latlng, {
                        radius: radius,
                        fillColor: conf.color,
                        color: 'white',
                        weight: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function(feature, layer) {
                    const val = feature.properties[conf.field] || 0;
                    const popupContent = `
                        <div class="custom-popup-header" style="background:${conf.color}">${feature.properties.nom}</div>
                        <div class="custom-popup-body">
                            <div class="popup-stat-row"><span>Type :</span> <strong>${conf.label}</strong></div>
                            <div class="popup-stat-row"><span>Volume :</span> <strong style="color:${conf.color}">${val} ${conf.unit}</strong></div>
                        </div>
                    `;
                    layer.bindPopup(popupContent);
                    layer.on('mouseover', function(e) { e.target.setStyle({weight: 3, color: '#333'}); e.target.openPopup(); });
                    layer.on('mouseout', function(e) { e.target.setStyle({weight: 1, color: 'white'}); e.target.closePopup(); });
                }
            }).addTo(map);

            updateLegend(key);
        }

        function calculateRadius(val, max) {
            if(!val) return 0;
            const minPx = 4; const maxPx = 35;
            return minPx + (val / max) * (maxPx - minPx);
        }

        function updateLegend(key) {
            const conf = CONFIG[key];
            const max = conf.max;
            const unit = conf.unit;
            const steps = [Math.round(max), Math.round(max/2), 5];
            let html = `<div class="legend-title">Légende : ${conf.label}</div>`;
            steps.forEach(val => {
                const r = calculateRadius(val, max) * 2;
                html += `<div class="legend-row"><span class="legend-circle" style="width:${r}px; height:${r}px; background:${conf.color}; opacity:0.8;"></span><span>~ ${val} ${unit}</span></div>`;
            });
            document.getElementById('legend-content').innerHTML = html;
        }

        function toggleDetails() {
            const panel = document.getElementById('details-text');
            const icon = document.getElementById('chevron-icon');
            if (panel.style.display === "block") {
                panel.style.display = "none";
                icon.className = "fa-solid fa-chevron-down";
            } else {
                panel.style.display = "block";
                icon.className = "fa-solid fa-chevron-up";
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
